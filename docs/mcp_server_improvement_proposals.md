# ClipCrow MCPサーバーへの改善提案

本プロジェクトでのクライアント実装（`serve.ts`）を通じて得られた知見に基づき、ClipCrow
MCPサーバーの改善提案をまとめました。
クライアント開発者の負担を軽減し、LLM（特にGemini）との親和性を高めるための提案です。

## 1. 初期化レスポンスでのセッションID明示

**現状:** クライアントは `initialize` リクエストを送信後、レスポンスヘッダー
(`x-session-id`) または SSE の `endpoint`
イベントからセッションIDを抽出する必要があります。

**課題:** これにはヘッダーの解析や SSE
ストリームのパース処理が初期段階で必須となり、クライアント実装のハードルが高くなっています。

**提案:** `initialize` メソッドの成功レスポンス（JSON-RPC
result）内に、割り当てられた `sessionId` を明示的に含めてください。

```json
// レスポンス例案
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "sessionId": "aedb303651144d63b0f6ea88baf94261", // 追加
    "capabilities": { ... },
    "serverInfo": { ... }
  }
}
```

これにより、クライアントは標準的な JSON-RPC
の戻り値としてIDを取得でき、ヘッダー解析やSSE待機が不要になります。

## 2. Gemini互換スキーマの提供（またはStrictモード）

**現状:** `tools/list` で返される JSON Schema に以下の要素が含まれており、Gemini
API でエラーとなります。

1. `uniqueItems: true`（Gemini非対応）
2. 数値型の `enum`（Geminiは `enum` 値を文字列として要求する傾向がある）

**課題:**
クライアント側でスキーマを再帰的に走査・修正（サニタイズ）する処理を実装しなければならず、メンテナンスコストが発生します。

**提案:** サーバー側でこれらの互換性問題を吸収することを提案します。

- **案A (デフォルト変更):** `uniqueItems` を出力しない、また Enum
  は可能な限り文字列型で定義する。
- **案B (オプション):** クライアント情報 (`clientInfo`) に `runtime: "gemini"`
  等が含まれる場合、あるいは `strict: true`
  パラメータを受け取った場合に、よりポータブルな（制約の緩い）スキーマを出力する。

## 3. 初期化時の SSE 強制の緩和

**現状:** `initialize` 呼び出しに対して、即座に
`Content-Type: text/event-stream` でレスポンスが返されます。

**課題:**
単純なハンドシェイクのためだけにストリーム処理を実装する必要があります。

**提案:** `initialize` や `tools/list`
などの単発的なリクエストに対しては、通常の `application/json`
レスポンスを返すオプション（またはデフォルト化）を検討してください。通知や長時間タスクが必要な場合のみ
SSE にアップグレードする、あるいは SSE 接続は別途 `/sse`
エンドポイント等で確立する設計の方が、HTTPベースの単純なクライアントにとっては扱いやすい可能性があります。

## 4. エラーメッセージの具体化

**現状:** セッションIDがない状態でリクエストすると `400 Bad Request`
が返りますが、詳細な理由がボディに含まれていない（あるいは見えにくい）ケースがありました。

**提案:** エラーレスポンスのボディ（JSON-RPC Error
オブジェクト）に、具体的な解決策（例: "Session ID missing. Please capture
x-session-id from initialize
response."）を含めることで、開発者がより迅速に問題を解決できるようになります。
